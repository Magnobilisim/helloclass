import{c as Y,u as Be,d as Ke,r as o,h as d,R as be,U as je,j as e,L as G,G as Qe,i as Xe}from"./index-C5K4Kfcd.js";import{C as Je,g as et}from"./imageUtils-D7V_6-By.js";import{I as tt,u as st}from"./mediaService-2JIBXRE6.js";import{u as at}from"./useAdTracking-Bm9s57CS.js";import{L as ye}from"./loader-circle-DJ3ru9dI.js";import{X as ve}from"./x-DstQxW1F.js";import{S as Ne}from"./send-BpVk3rmn.js";import"./adTrackingService-DSpkMtQT.js";/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],ot=Y("message-square",lt);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]],nt=Y("thumbs-down",rt);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],dt=Y("thumbs-up",it),jt=()=>{const{user:a,users:N,posts:w,addPost:C,toggleLike:S,toggleDislike:I,addComment:k,reportPost:we,availableSubjects:A,schools:R,toggleFollow:Ce,t:l,showAlert:q,manualAds:V,socialTopics:_,formatDisplayName:Se}=Be(),Ie=Ke(),[u,Z]=o.useState(""),[P,W]=o.useState(""),[T,B]=o.useState(""),[K,Q]=o.useState(""),[X,M]=o.useState(!1),g=o.useRef(null),[f,J]=o.useState(""),[z,ke]=o.useState("All"),[U,Ae]=o.useState("All"),[E,ee]=o.useState(null),[te,L]=o.useState(d.INAPPROPRIATE),[se,Re]=o.useState(new Set),[ae,le]=o.useState({}),[oe,re]=o.useState(null),[x,O]=o.useState(null),[b,F]=o.useState(null),[_e,Pe]=o.useState({x:0,y:0}),[Te,ne]=o.useState(1),[ie,Me]=o.useState(0),[ze,Ue]=o.useState(void 0),[de,Ee]=o.useState(null),[ce,xe]=o.useState(!1),Le=async()=>{if(!u.trim()&&!x)return;M(!0);let t;if(x)try{t=await st(x)}catch{q("Failed to upload image","error"),M(!1);return}const s=[];P&&s.push(P),T&&s.push(`general:${T}`);const r=await C(u,s.length?s:void 0,K||void 0,t);M(!1),r.success?(Z(""),W(""),B(""),Q(""),O(null)):r.reason&&re(r.reason)},Oe=t=>{var n;const s=(n=t.target.files)==null?void 0:n[0];if(!s)return;const r=new FileReader;r.onloadend=()=>{F(r.result),ne(1),Me(0),Ue(void 0)},r.readAsDataURL(s),g.current&&(g.current.value="")},Fe=o.useCallback((t,s)=>{Ee(s)},[]),$e=async()=>{if(!(!b||!de)){xe(!0);try{const t=await et(b,de,ie);t&&(O(t),F(null))}catch(t){console.error(t),q("Failed to crop image","error")}finally{xe(!1)}}},He=t=>{L(d.INAPPROPRIATE),ee(t)},$=()=>{ee(null),L(d.INAPPROPRIATE)},De=()=>{E&&(we(E,te),$())},Ge=t=>{const s=new Set(se);s.has(t)?s.delete(t):s.add(t),Re(s)},me=t=>{const s=ae[t];s&&s.trim()&&(k(t,s),le(r=>({...r,[t]:""})))},Ye=t=>{const s=t.target.value;if(s==="MY_SCHOOL"){if(!(a!=null&&a.schoolId)){window.confirm("You haven't selected a school yet. Go to profile to update?")&&Ie(Ve);return}J(a.schoolId)}else J(s)},H=w.filter(t=>{var s,r;if(f&&t.schoolId!==f||z!=="All"&&!((s=t.tags)!=null&&s.includes(z)))return!1;if(U!=="All"){const n=`general:${U}`;if(!((r=t.tags)!=null&&r.includes(n)))return!1}return!0}),h=be.useMemo(()=>V.filter(t=>t.isActive&&(t.placement==="social"||t.placement==="both")),[V]),D=a==null?void 0:a.role,qe=a==null?void 0:a.schoolId,Ve=D===je.TEACHER?"/teacher/profile":D===je.ADMIN?"/admin/profile":"/student/profile",he=(t,s,r)=>{const n=N.find(c=>c.id===t);return n?Se(n,{withAt:!0}):r?`@${r}`:s},pe=be.useMemo(()=>{if(!h.length)return H.map(n=>({type:"post",post:n}));const t=[],s=5;let r=0;if(H.forEach((n,c)=>{if(c>0&&c%s===0){const j=h[r%h.length];t.push({type:"ad",ad:j,key:`social-feed-ad-${c}-${j.id}-${r}`}),r++}t.push({type:"post",post:n})}),!t.some(n=>n.type==="ad")){const n=h[0];t.splice(Math.min(1,t.length),0,{type:"ad",ad:n,key:`social-feed-ad-fallback-${n.id}`})}return t},[H,h]);return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6 pb-20 relative",children:[b&&e.jsxs("div",{className:"fixed inset-0 z-50 bg-black flex flex-col animate-fade-in",children:[e.jsx("div",{className:"relative flex-1 w-full bg-black/50",children:e.jsx(Je,{image:b,crop:_e,zoom:Te,rotation:ie,aspect:ze,onCropChange:Pe,onCropComplete:Fe,onZoomChange:ne})}),e.jsx("div",{className:"bg-white p-6 rounded-t-3xl z-20",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>F(null),className:"flex-1 py-3 bg-gray-100 rounded-xl font-bold",children:"Cancel"}),e.jsx("button",{onClick:$e,disabled:ce,className:"flex-2 py-3 bg-brand-500 text-white rounded-xl font-bold w-full flex justify-center items-center gap-2",children:ce?e.jsx(ye,{className:"animate-spin"}):"Save Image"})]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:l("classroom_feed")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:f===(a==null?void 0:a.schoolId)?"MY_SCHOOL":f,onChange:Ye,className:"p-2 rounded-xl text-xs font-bold border border-gray-200 outline-none bg-white text-gray-700 max-w-[140px] truncate",children:[e.jsx("option",{value:"",children:l("all_schools")}),e.jsx("option",{value:"MY_SCHOOL",children:l("my_school")}),e.jsx("option",{disabled:!0,children:"──────────"}),R.filter(t=>t.id!==(a==null?void 0:a.schoolId)).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:z,onChange:t=>ke(t.target.value),className:"p-2 rounded-xl text-xs font-bold border border-gray-200 outline-none bg-white text-gray-700",children:[e.jsx("option",{value:"All",children:l("all")}),A.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:U,onChange:t=>Ae(t.target.value),className:"p-2 rounded-xl text-xs font-bold border border-gray-200 outline-none bg-white text-gray-700",children:[e.jsxs("option",{value:"All",children:[l("all")," ",l("topic")]}),_.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-3xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex gap-3 mb-3",children:[e.jsx("img",{src:a==null?void 0:a.avatar,className:"w-10 h-10 rounded-full bg-gray-100"}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("textarea",{value:u,onChange:t=>Z(t.target.value),placeholder:l("share_placeholder"),className:"w-full bg-gray-50 rounded-xl p-3 outline-none resize-none text-sm h-20 text-gray-900"}),x&&e.jsxs("div",{className:"relative w-full h-48 bg-gray-50 rounded-xl overflow-hidden border border-gray-200",children:[e.jsx("img",{src:x,className:"w-full h-full object-contain"}),e.jsx("button",{onClick:()=>O(null),className:"absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full",children:e.jsx(ve,{size:16})})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsx("input",{type:"file",ref:g,className:"hidden",accept:"image/*",onChange:Oe}),e.jsx("button",{onClick:()=>{var t;return(t=g.current)==null?void 0:t.click()},className:"p-2 bg-gray-100 text-gray-500 rounded-lg",children:e.jsx(tt,{size:20})}),e.jsxs("select",{value:P,onChange:t=>W(t.target.value),className:"flex-1 md:flex-none text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 outline-none text-gray-700 font-medium",children:[e.jsxs("option",{value:"",children:[l("topic"),"..."]}),A.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:T,onChange:t=>B(t.target.value),className:"flex-1 md:flex-none text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 outline-none text-gray-700 font-medium",children:[e.jsx("option",{value:"",children:l("social_topic_placeholder")}),_.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:K,onChange:t=>Q(t.target.value),className:"flex-1 md:flex-none text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 outline-none text-gray-700 font-medium max-w-[150px] truncate",children:[e.jsx("option",{value:"",children:l("global")}),(a==null?void 0:a.schoolId)&&e.jsx("option",{value:a.schoolId,children:l("my_school")}),e.jsx("option",{disabled:!0,children:"──────────"}),R.filter(t=>t.id!==(a==null?void 0:a.schoolId)).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("button",{onClick:Le,disabled:X||!u.trim()&&!x,className:"w-full md:w-auto bg-brand-500 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-2 disabled:opacity-50",children:[X?e.jsx(ye,{className:"animate-spin",size:14}):e.jsx(Ne,{size:14})," ",l("post_btn")]})]})]}),e.jsx("div",{className:"space-y-4",children:pe.length>0?pe.map(t=>{var ue,ge,fe;if(t.type==="ad")return e.jsx(ct,{ad:t.ad,label:l("ads"),userId:a==null?void 0:a.id,userRole:D,locationHint:qe},t.key);const s=t.post,r=s.schoolId?(ue=R.find(i=>i.id===s.schoolId))==null?void 0:ue.name:"Global",n=(a==null?void 0:a.id)===s.authorId,c=(ge=a==null?void 0:a.following)==null?void 0:ge.includes(s.authorId),j=he(s.authorId,s.authorName,s.authorUsername);return e.jsxs("div",{className:"bg-white p-5 rounded-3xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(G,{to:`/student/profile/${s.authorId}`,children:e.jsx("img",{src:s.authorAvatar,className:"w-10 h-10 rounded-full border border-gray-100"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{to:`/student/profile/${s.authorId}`,className:"font-bold text-gray-800 text-sm",children:j}),!n&&e.jsx("button",{onClick:()=>Ce(s.authorId),className:"text-[10px] bg-brand-50 text-brand-600 px-2 py-0.5 rounded-lg font-bold",children:l(c?"following":"follow")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-400 flex-wrap",children:[e.jsx("span",{children:new Date(s.timestamp).toLocaleDateString()}),e.jsxs("span",{className:"bg-blue-50 text-blue-500 px-1.5 rounded font-bold",children:[e.jsx(Qe,{size:10,className:"inline mr-1"})," ",r]}),(fe=s.tags)==null?void 0:fe.map(i=>{var y,p;if(i.startsWith("general:")){const v=i.replace("general:",""),Ze=((y=_.find(We=>We.id===v))==null?void 0:y.name)||v;return e.jsx("span",{className:"bg-amber-50 text-amber-600 px-1.5 rounded font-bold text-[10px]",children:Ze},i)}const m=((p=A.find(v=>v.id===i))==null?void 0:p.name)||i;return e.jsx("span",{className:"bg-gray-100 text-gray-600 px-1.5 rounded",children:m},i)})]})]})]}),e.jsx("button",{onClick:()=>He(s.id),className:"text-gray-300 hover:text-red-500",children:e.jsx(Xe,{size:14})})]}),s.content&&e.jsx("p",{className:"text-gray-900 font-medium mb-4 whitespace-pre-wrap",children:s.content}),s.imageUrl&&e.jsx("div",{className:"mb-4 rounded-2xl overflow-hidden border border-gray-100",children:e.jsx("img",{src:s.imageUrl,className:"w-full max-h-[400px] object-cover"})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-50",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("button",{onClick:()=>S(s.id),className:"flex items-center gap-1.5 text-gray-500 hover:text-green-600",children:[e.jsx(dt,{size:18}),e.jsx("span",{className:"text-xs font-bold",children:s.likes})]}),e.jsxs("button",{onClick:()=>I(s.id),className:"flex items-center gap-1.5 text-gray-500 hover:text-red-600",children:[e.jsx(nt,{size:18}),e.jsx("span",{className:"text-xs font-bold",children:s.dislikes})]})]}),e.jsxs("button",{onClick:()=>Ge(s.id),className:"flex items-center gap-2 text-gray-500 hover:text-blue-500",children:[e.jsxs("span",{className:"text-xs font-bold",children:[s.comments.length," ",l("comments")]}),e.jsx(ot,{size:18})]})]}),se.has(s.id)&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-50 bg-gray-50/50 rounded-xl p-3",children:[e.jsx("div",{className:"space-y-3 mb-4",children:s.comments.map(i=>{var p;const m=he(i.authorId,i.authorName,i.authorUsername),y=((p=m.replace(/^@/,"").charAt(0))==null?void 0:p.toUpperCase())||"U";return e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-brand-100 flex items-center justify-center text-xs font-bold text-brand-600 shrink-0",children:y}),e.jsxs("div",{className:"bg-white p-2 rounded-r-xl rounded-bl-xl border border-gray-100 shadow-sm text-sm",children:[e.jsx(G,{to:`/student/profile/${i.authorId}`,className:"font-bold text-gray-800 text-xs block",children:m}),e.jsx("p",{className:"text-gray-700",children:i.text})]})]},i.id)})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:l("write_comment"),value:ae[s.id]||"",onChange:i=>le(m=>({...m,[s.id]:i.target.value})),onKeyDown:i=>i.key==="Enter"&&me(s.id),className:"flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none text-gray-900"}),e.jsx("button",{onClick:()=>me(s.id),className:"text-brand-600",children:e.jsx(Ne,{size:16})})]})]})]},s.id)}):e.jsx("div",{className:"text-center py-10 text-gray-400",children:"No posts found."})}),oe&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"bg-white w-full max-w-md rounded-3xl p-8 relative shadow-2xl border-4 border-red-100",children:[e.jsx("h3",{className:"font-black text-2xl text-center text-gray-900 mb-2",children:l("safety_warning")}),e.jsx("p",{className:"text-center text-gray-500 mb-6",children:oe}),e.jsx("button",{onClick:()=>re(null),className:"w-full bg-gray-900 text-white py-4 rounded-xl font-bold",children:l("understand")})]})}),E&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"bg-white w-full max-w-md rounded-3xl p-6 relative shadow-2xl",children:[e.jsx("button",{onClick:$,className:"absolute top-3 right-3 text-gray-400 hover:text-gray-600",children:e.jsx(ve,{size:18})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:l("report")}),e.jsx("p",{className:"text-sm text-gray-500",children:l("report_modal_hint")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-600 uppercase tracking-wide",children:l("reason")}),e.jsxs("select",{value:te,onChange:t=>L(t.target.value),className:"w-full border border-gray-200 rounded-xl p-3 text-sm bg-gray-50",children:[e.jsx("option",{value:d.SPAM,children:l("report_reason_spam")}),e.jsx("option",{value:d.HARASSMENT,children:l("report_reason_harassment")}),e.jsx("option",{value:d.INAPPROPRIATE,children:l("report_reason_inappropriate")}),e.jsx("option",{value:d.MISINFORMATION,children:l("report_reason_misinformation")}),e.jsx("option",{value:d.OTHER,children:l("report_reason_other")})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:$,className:"flex-1 border border-gray-200 rounded-xl py-3 font-bold text-gray-600",children:l("cancel")}),e.jsx("button",{onClick:De,className:"flex-1 bg-red-500 text-white rounded-xl py-3 font-bold",children:l("report")})]})]})]})})]})},ct=({ad:a,label:N,userId:w,userRole:C,locationHint:S})=>{const{adRef:I,logAdClick:k}=at({adId:a.id,placement:a.placement,context:"social",userId:w,userRole:C,locationHint:S});return e.jsxs("div",{ref:I,className:"bg-white p-5 rounded-3xl border border-amber-100 shadow-sm flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-amber-500",children:N}),a.highlightLabel&&e.jsx("span",{className:"text-[10px] font-black text-amber-400 uppercase",children:a.highlightLabel})]}),e.jsx("h4",{className:"text-lg font-black text-gray-900",children:a.title}),a.description&&e.jsx("p",{className:"text-sm text-gray-600",children:a.description}),a.imageUrl&&e.jsx("div",{className:"rounded-2xl overflow-hidden border border-gray-100",children:e.jsx("img",{src:a.imageUrl,className:"w-full h-44 object-cover"})}),a.ctaText&&a.ctaUrl&&e.jsx("a",{href:a.ctaUrl,target:"_blank",rel:"noreferrer",onClick:k,className:"inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-bold bg-amber-500 text-white hover:bg-amber-600",children:a.ctaText})]})};export{jt as SocialFeed};
