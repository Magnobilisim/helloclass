import{u as Qe,d as Re,f as Ke,r as o,U as I,j as t,v as Oe}from"./index-C5K4Kfcd.js";import{C as Be,g as Ge}from"./imageUtils-D7V_6-By.js";import{I as le,u as De}from"./mediaService-2JIBXRE6.js";import{L as ce}from"./loader-circle-DJ3ru9dI.js";import{A as He}from"./arrow-left-DC4CkvUa.js";import{B as Fe}from"./bot-CPX00xs-.js";import{T as We,P as Ze}from"./trash-2-OCDLetU-.js";import{X as de}from"./x-DstQxW1F.js";import{C as Me}from"./check-C4w6hC7_.js";import{S as Xe}from"./save-uRNP2Y-w.js";const C=(i,b)=>{if(!b)return"";const P=typeof b.grade=="number"?`grade-${b.grade}`:b.level?`level-${b.level}`:"general";return`${i}::${b.name.toLowerCase()}::${P}`},it=()=>{var oe;const{user:i,addExam:b,updateExam:P,exams:S,approvedTopics:D,availableSubjects:E,t:n,showAlert:m,language:me,systemSettings:ue,updateUser:pe,logAiUsage:ge}=Qe(),$=Re(),{id:d}=Ke(),[Q,H]=o.useState(""),[L,z]=o.useState(""),[xe,he]=o.useState("Easy"),[w,F]=o.useState(1),[k,W]=o.useState("A1"),[Z,M]=o.useState(15),[R,X]=o.useState("0"),[K,J]=o.useState(!1),[l,T]=o.useState(""),[fe,be]=o.useState(""),[ve,ye]=o.useState(""),[p,h]=o.useState([{id:"q1",text:"",options:["","","",""],correctIndex:0,explanation:""}]),[V,Y]=o.useState(null),[O,A]=o.useState(""),[U,B]=o.useState(null),[je,q]=o.useState({x:0,y:0}),[Ne,ee]=o.useState(1),[te,Ce]=o.useState(0),[we,_e]=o.useState(void 0),[se,Ie]=o.useState(null),[ae,re]=o.useState(null),g="w-full bg-white border border-gray-300 rounded-xl p-3 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all font-medium",f="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide",G=(i==null?void 0:i.role)===I.TEACHER&&ue.aiWizardCost||0,v=E.filter(e=>e.name==="İngilizce"||e.name==="English"?!0:e.grades.includes(w));o.useEffect(()=>{v.length>0&&(v.find(s=>s.id===l)||T(v[0].id))},[w,v,l]);const y=(D[l]||[]).filter(e=>{const s=E.find(a=>a.id===l);return(s==null?void 0:s.name)==="English"||(s==null?void 0:s.name)==="İngilizce"?e.level===k:e.grade===w});o.useEffect(()=>{if(y.length===0){A("");return}const e=y.find(a=>C(l,a)===O);if(e){z(e.name);return}const s=y[0];A(C(l,s)),z(s.name)},[y,l]),o.useEffect(()=>{if(!d)return;const e=S.find(s=>s.id===d);if(e&&(e.creatorId===(i==null?void 0:i.id)||(i==null?void 0:i.role)===I.ADMIN)){if(H(e.title),z(e.topic||""),T(e.subjectId),he(e.difficulty),M(e.timeLimit),X(String(e.price??0)),h(e.questions.map(s=>({...s,options:[...s.options],optionImages:s.optionImages?[...s.optionImages]:void 0}))),e.classLevel&&F(e.classLevel),e.englishLevel&&W(e.englishLevel),e.topicKey)A(e.topicKey);else if(e.topic){const s=(D[e.subjectId]||[]).find(a=>a.name===e.topic);s&&A(C(e.subjectId,s))}be(e.creatorId),ye(e.creatorName)}else m("Unauthorized to edit this exam.","error"),$((i==null?void 0:i.role)===I.ADMIN?"/admin/exams":"/teacher")},[d,S,i,$,m]),o.useEffect(()=>{d||v.length>0&&!l&&T(v[0].id)},[d,v,l]);const Ee=()=>{h([...p,{id:`q-${Date.now()}`,text:"",options:["","","",""],correctIndex:0,explanation:""}])},ze=e=>{p.length!==1&&h(p.filter((s,a)=>a!==e))},_=(e,s,a)=>{const r=[...p];r[e]={...r[e],[s]:a},h(r)},Ae=e=>{const s=[...p],a=s[e];if(a.options.length>=5){m("Maximum 5 options allowed","warning");return}a.options.push(""),a.optionImages&&a.optionImages.push(""),h(s)},Se=(e,s)=>{const a=[...p],r=a[e];if(r.options.length<=2){m("Minimum 2 options required","warning");return}r.options.splice(s,1),r.optionImages&&r.optionImages.splice(s,1),r.correctIndex===s?r.correctIndex=0:r.correctIndex>s&&(r.correctIndex-=1),h(a)},$e=(e,s,a)=>{const r=[...p];r[e].options[s]=a,h(r)},Le=(e,s)=>{h(a=>{const r=[...a],u=r[e];return r[e]={...u,text:s.text,options:[...s.options],correctIndex:s.correctIndex,explanation:s.explanation||"",imageUrl:s.imageUrl,optionImages:void 0},r})},ke=async e=>{if(!i)return;const s=i.role===I.TEACHER?G:0;if(s>0&&(i.points||0)<s){m(n("insufficient_points_message").replace("{points}",`${s}`),"error");return}const a=E.find(c=>c.id===l),r=(a==null?void 0:a.name)||"General",u=(a==null?void 0:a.name)==="English"||(a==null?void 0:a.name)==="İngilizce"?k:`Grade ${w}`;Y(e);try{const c=await Oe({subjectName:r,gradeOrLevel:u,topic:L||void 0,questionCount:1,language:me});if(!c||!c.length)throw new Error(n("ai_generate_question_error"));if(Le(e,c[0]),s>0){const x=(i.points||0)-s;pe({...i,points:x}),ge({userId:i.id,examId:d||`draft-${Date.now()}`,questionIndex:e,cost:s,creditsAfter:x,topic:L||r,subjectId:l,note:"ai_wizard_question"}),m(n("ai_wizard_payment_success").replace("{points}",`${s}`),"success")}else m(n("ai_generate_question_success"),"success")}catch(c){console.error(c),m(c.message||n("ai_generate_question_error"),"error")}finally{Y(null)}},ne=(e,s)=>{const a=new FileReader;a.onloadend=()=>{B(a.result),re(s),ee(1),Ce(0),_e(void 0),q({x:0,y:0})},a.readAsDataURL(e)},Te=o.useCallback((e,s)=>{Ie(s)},[]),Ue=async()=>{if(!(!U||!se||!ae)){J(!0);try{const e=await Ge(U,se,te);if(e){const s=await De(e),{qIndex:a,type:r,oIndex:u}=ae;if(r==="question")_(a,"imageUrl",s);else if(r==="explanation")_(a,"explanationImage",s);else if(r==="option"&&typeof u=="number"){const c=[...p],x=c[a],j=x.optionImages||new Array(x.options.length).fill("");for(;j.length<x.options.length;)j.push("");j[u]=s,c[a]={...x,optionImages:j},h(c)}B(null),re(null)}}catch(e){console.error(e),m("Failed to process image","error")}finally{J(!1)}}},Pe=e=>{var x,j;if(e.preventDefault(),!i)return;if(!Q.trim()){m(n("title_req"),"error");return}const s=R.trim()===""?0:Number(R);if(Number.isNaN(s)){m(n("price_negative_error"),"error");return}if(s<0){m(n("price_negative_error"),"error");return}if(p.length<5){m(n("min_questions_error"),"error");return}const a=E.find(N=>N.id===l),r=y.find(N=>C(l,N)===O),u=r?r.name:L,c={id:d||`exam-${Date.now()}`,title:Q,topic:u,creatorId:d?fe:i.id,creatorName:d?ve:i.name,subjectId:l,difficulty:xe,timeLimit:Z,price:s,sales:d&&((x=S.find(N=>N.id===d))==null?void 0:x.sales)||0,rating:d&&((j=S.find(N=>N.id===d))==null?void 0:j.rating)||0,isPublished:!0,questions:p,classLevel:(a==null?void 0:a.name)!=="English"&&(a==null?void 0:a.name)!=="İngilizce"?w:void 0,englishLevel:(a==null?void 0:a.name)==="English"||(a==null?void 0:a.name)==="İngilizce"?k:void 0,topicKey:r?C(l,r):void 0,curriculumPath:r?{subjectId:l,topicName:r.name,grade:r.grade,level:r.level}:void 0};d?P(c):b(c),$(i.role===I.ADMIN?"/admin/exams":"/teacher")},ie=(oe=E.find(e=>e.id===l))==null?void 0:oe.name;return t.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 pb-20",children:[U&&t.jsxs("div",{className:"fixed inset-0 z-50 bg-black flex flex-col animate-fade-in",children:[t.jsx("div",{className:"relative flex-1 w-full bg-black/50",children:t.jsx(Be,{image:U,crop:je,zoom:Ne,rotation:te,aspect:we,onCropChange:q,onCropComplete:Te,onZoomChange:ee})}),t.jsx("div",{className:"bg-white p-6 rounded-t-3xl z-20",children:t.jsxs("div",{className:"flex gap-4",children:[t.jsx("button",{onClick:()=>B(null),disabled:K,className:"flex-1 py-3 bg-gray-100 rounded-xl font-bold",children:n("cancel")}),t.jsx("button",{onClick:Ue,disabled:K,className:"flex-2 py-3 bg-brand-500 text-white rounded-xl font-bold w-full flex justify-center items-center gap-2",children:K?t.jsx(ce,{className:"animate-spin"}):n("save")})]})})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("button",{onClick:()=>$(-1),className:"p-2 hover:bg-white rounded-full transition-colors",children:t.jsx(He,{className:"text-gray-700"})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:n(d?"edit":"create_exam")})]}),t.jsxs("form",{onSubmit:Pe,className:"space-y-8",children:[t.jsx("div",{className:"bg-white p-8 rounded-3xl shadow-sm border border-gray-100 space-y-6",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[ie==="English"||ie==="İngilizce"?t.jsxs("div",{children:[t.jsx("label",{className:f,children:n("level")}),t.jsx("select",{value:k,onChange:e=>W(e.target.value),className:g,children:["A1","A2","B1","B2"].map(e=>t.jsx("option",{value:e,children:e},e))})]}):t.jsxs("div",{children:[t.jsx("label",{className:f,children:n("grade")}),t.jsx("select",{value:w,onChange:e=>F(Number(e.target.value)),className:g,children:Array.from({length:12},(e,s)=>s+1).map(e=>t.jsxs("option",{value:e,children:[e,". ",n("grade")]},e))})]}),t.jsxs("div",{children:[t.jsx("label",{className:f,children:n("subject")}),t.jsx("select",{value:l,onChange:e=>T(e.target.value),className:g,children:v.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:f,children:n("topic")}),y.length>0?t.jsx("select",{value:O,onChange:e=>{const s=e.target.value;A(s);const a=y.find(r=>C(l,r)===s);a&&z(a.name)},className:g,children:y.map((e,s)=>t.jsxs("option",{value:C(l,e),children:[e.name," ",e.grade?`• ${e.grade}. ${n("grade")}`:e.level?`• ${e.level}`:""]},`${e.name}-${s}`))}):t.jsx("input",{value:L,onChange:e=>z(e.target.value),className:g,placeholder:n("enter_topic")})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:f,children:n("title")}),t.jsx("input",{value:Q,onChange:e=>H(e.target.value),className:g,placeholder:n("enter_title")})]}),t.jsxs("div",{children:[t.jsx("label",{className:f,children:n("time_min")}),t.jsx("input",{type:"number",value:Z,onChange:e=>M(Number(e.target.value)),className:g})]}),t.jsxs("div",{children:[t.jsx("label",{className:f,children:n("price")}),t.jsx("input",{type:"number",value:R,onChange:e=>X(e.target.value),className:g})]})]})}),t.jsx("div",{className:"space-y-8",children:p.map((e,s)=>t.jsxs("div",{className:"bg-white p-6 rounded-3xl shadow-sm border border-gray-200",children:[t.jsxs("div",{className:"flex justify-between mb-4",children:[t.jsxs("span",{className:"font-bold bg-brand-500 text-white px-4 py-1.5 rounded-xl shadow-sm shadow-brand-200",children:[n("question")," ",s+1]}),t.jsxs("div",{className:"flex gap-2 items-center",children:[t.jsxs("button",{type:"button",onClick:()=>ke(s),disabled:V===s,className:"px-3 py-2 rounded-xl bg-indigo-50 text-indigo-600 font-bold text-xs flex items-center gap-2 hover:bg-indigo-100 transition-colors disabled:opacity-60",children:[V===s?t.jsx(ce,{size:16,className:"animate-spin"}):t.jsx(Fe,{size:16}),n("ai_generate_question")]}),t.jsxs("label",{className:"cursor-pointer p-2 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors",children:[t.jsx(le,{size:20,className:"text-gray-600"}),t.jsx("input",{type:"file",className:"hidden",onChange:a=>{var r;(r=a.target.files)!=null&&r[0]&&ne(a.target.files[0],{qIndex:s,type:"question"})}})]}),t.jsx("button",{type:"button",onClick:()=>ze(s),className:"p-2 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 transition-colors",children:t.jsx(We,{size:20})})]})]}),t.jsxs("div",{className:"mb-6",children:[e.imageUrl&&t.jsxs("div",{className:"mb-3 w-full h-48 relative bg-gray-50 rounded-xl border border-gray-100 overflow-hidden group",children:[t.jsx("img",{src:e.imageUrl,className:"w-full h-full object-contain"}),t.jsx("button",{type:"button",onClick:()=>_(s,"imageUrl",void 0),className:"absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity",children:t.jsx(de,{size:16})})]}),(i==null?void 0:i.role)===I.TEACHER&&G>0&&t.jsx("p",{className:"text-xs text-gray-400 font-bold mb-2",children:n("ai_generate_question_cost").replace("{points}",`${G}`)}),t.jsx("label",{className:f,children:n("enter_question")}),t.jsx("textarea",{value:e.text,onChange:a=>_(s,"text",a.target.value),className:g,rows:3,placeholder:"What is 2 + 2?"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.options.map((a,r)=>t.jsxs("div",{className:"flex gap-3 items-center bg-gray-50 p-3 rounded-xl border border-gray-100",children:[t.jsx("button",{type:"button",onClick:()=>_(s,"correctIndex",r),className:`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${e.correctIndex===r?"bg-green-500 border-green-500 text-white shadow-md shadow-green-200":"bg-white border-gray-300 text-transparent hover:border-green-300"}`,children:t.jsx(Me,{size:16})}),t.jsx("input",{value:a,onChange:u=>$e(s,r,u.target.value),className:"flex-1 bg-white border border-gray-200 rounded-lg p-2.5 text-sm font-medium text-gray-900 focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500",placeholder:`${n("option")} ${r+1}`}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs("label",{className:"cursor-pointer p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-lg transition-colors",children:[t.jsx(le,{size:16}),t.jsx("input",{type:"file",className:"hidden",onChange:u=>{var c;(c=u.target.files)!=null&&c[0]&&ne(u.target.files[0],{qIndex:s,type:"option",oIndex:r})}})]}),e.options.length>2&&t.jsx("button",{type:"button",onClick:()=>Se(s,r),className:"p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",children:t.jsx(de,{size:16})})]})]},r)),e.options.length<5&&t.jsxs("button",{type:"button",onClick:()=>Ae(s),className:"w-full py-3 border-2 border-dashed border-brand-200 text-brand-600 rounded-xl font-bold hover:bg-brand-50 transition-colors flex items-center justify-center gap-2",children:[t.jsx(Ze,{size:18})," ",n("add_question")]})]}),t.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[t.jsx("label",{className:f,children:n("explanation")}),t.jsx("textarea",{value:e.explanation,onChange:a=>_(s,"explanation",a.target.value),className:g,rows:2,placeholder:n("enter_explanation")})]})]},e.id))}),t.jsxs("div",{className:"flex gap-4 sticky bottom-6 z-30",children:[t.jsxs("button",{type:"button",onClick:Ee,className:"flex-1 py-4 bg-white border-2 border-dashed border-gray-300 text-gray-600 rounded-xl font-bold shadow-lg hover:bg-gray-50 transition-all",children:["+ ",n("add_question")]}),t.jsxs("button",{type:"submit",className:"flex-[2] py-4 bg-gray-900 text-white rounded-xl font-bold shadow-xl hover:bg-gray-800 hover:scale-[1.01] transition-all flex items-center justify-center gap-2",children:[t.jsx(Xe,{size:20})," ",n("save")]})]})]})]})};export{it as CreateExam};
